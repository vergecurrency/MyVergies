name: Build, test and deploy MyVergies

on: [push]

jobs:
  test:
    runs-on: macos-latest

    strategy:
      matrix:
        node-version: [13.x]

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      # Cache node_modules (kept your original style)
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json', '**/npm-shrinkwrap.json') }}
          restore-keys: |
            ${{ runner.os }}-node${{ matrix.node-version }}-

      - name: npm install, lint and test
        run: |
          npm install
          npm run lint
          npm run test:unit:ci
        env:
          GRANAX_TOR_VERSION: 13.0.10

  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 13.x
        uses: actions/setup-node@v4
        with:
          node-version: 13.x

      - name: Cache node modules
        uses: actions/cache@v4
        if: contains(matrix.os, 'macos') || contains(matrix.os, 'ubuntu')
        with:
          path: node_modules
          key: ${{ runner.os }}-node13.x-${{ hashFiles('**/package-lock.json', '**/npm-shrinkwrap.json') }}
          restore-keys: |
            ${{ runner.os }}-node13.x-

      - name: add macOS signing certificate
        if: contains(matrix.os, 'macos') && startsWith(github.ref, 'refs/tags/')
        run: |
          security create-keychain -p ${{ secrets.CSC_KEY_PASSWORD }} buildagent.keychain
          security unlock-keychain -p ${{ secrets.CSC_KEY_PASSWORD }} buildagent.keychain
          security list-keychains -d user -s buildagent.keychain
          security default-keychain -s buildagent.keychain
          security import ./dist_electron/certs/DeveloperIDApplication.p12 -k buildagent.keychain -P ${{ secrets.CSC_KEY_PASSWORD }} -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k ${{ secrets.CSC_KEY_PASSWORD }} buildagent.keychain

      - name: npm install and build
        run: |
          npm ci
          npm run electron:build
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASS: ${{ secrets.APPLE_ID_PASS }}
          APPLE_ASC_PROVIDER: ${{ secrets.APPLE_ASC_PROVIDER }}
          NOTARIZE: ${{ startsWith(github.ref, 'refs/tags/') }}
          GRANAX_TOR_VERSION: 10.0.15

      - name: Cleanup artifacts
        if: startsWith(github.ref, 'refs/tags/')
        run: npm run electron:clean:dist

      - name: Upload artifacts
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}
          path: dist_electron

      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: 'dist_electron/**'
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
